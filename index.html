<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FFFFFF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="./style.css">
</head>
<body>


<header>
  <div class="topbar">
   <div class="cont">
      <div class="bigt">Hábitos</div>
   </div>
   <div id="dateSelector"><input type="date" id="selectedDate"></div>   
   </div>
</header>

<button id="addHabitBtn">􀅼</button>
<main id="habitsContainer"></main>

<div id="createSheet" class="sheetContent" style="min-height: 99%;">
   <div class="headerB">
        <div class="spaceline">
            <div class="line"></div>
        </div>
        <div class="centro">
            <button class="btn-cancel" onclick="closeSheet('createSheet')">􀆄</button>
            <div class="subtitle">Hábito</div>
            <button class="btn-action" onclick="closeSheet('createSheet')">􀏈</button>
        </div>
    </div>
    <div class="iconTrigger" id="iconPickerTrigger">􀓔</div>
    <div class="form">
      <input type="text" id="hName" class="field" placeholder="Nombre del hábito">
      <div class="table">
         <div class="row" style="border:none; justify-content: center; padding: 12px 0;">
<div class="colorPresets">
  <input type="radio" name="presetColor" id="color1" value="#ea4e3d">
  <label for="color1" style="background:#ea4e3d;"></label>
  
  <input type="radio" name="presetColor" id="color2" value="#f09a37">
  <label for="color2" style="background:#f09a37;"></label>
  
  <input type="radio" name="presetColor" id="color3" value="#FFCC00">
  <label for="color3" style="background:#FFCC00;"></label>
  
  <input type="radio" name="presetColor" id="color4a" value="#34C759">
  <label for="color4a" style="background:#34C759;"></label>
  
  <input type="radio" name="presetColor" id="color4b" value="#00C8B3">
  <label for="color4b" style="background:#00C8B3;"></label>
  
  <input type="radio" name="presetColor" id="color4c" value="#00C3D0">
  <label for="color4c" style="background:#00C3D0;"></label>
  
  <input type="radio" name="presetColor" id="color5a" value="#007aff">
  <label for="color5a" style="background:#007aff;"></label>

  <input type="radio" name="presetColor" id="color5b" value="#5856ce">
  <label for="color5b" style="background:#5856ce;"></label>

  <input type="radio" name="presetColor" id="color5c" value="#CB30E0">
  <label for="color5c" style="background:#CB30E0;"></label>

  <input type="radio" name="presetColor" id="color5d" value="#d7506b">
  <label for="color5d" style="background:#d7506b;"></label>

  <input type="radio" name="presetColor" id="color5e" value="#d1a8a0">
  <label for="color5e" style="background:#d1a8a0;"></label>

  <input type="radio" name="presetColor" id="color5f" value="#998567">
  <label for="color5f" style="background:#998567;"></label>

  <div class="colorPickerWrap">
     <input type="color" id="iconColorPicker" value="#007AFF">
     <div class="colorPreview" id="colorPreview" style="background:#007AFF;"></div>
  </div>
</div>

         </div>
      </div>
    <div class="table">
        <div class="row"><input type="text" id="uSing" class="field" placeholder="Unidad singular"></div>
        <div class="row"><input type="text" id="uPlur" class="field" placeholder="Unidad plural"></div>
    </div>
    <div class="table">
        <div class="row"><input type="number" id="hGoal" class="field" placeholder="Meta diaria" inputmode="numeric"></div>
        <div class="row"><input type="number" id="hStep" class="field"placeholder="Paso" inputmode="numeric"></div>
    </div>
    <div class="table">
    </div>
   </div>
</div>

<div id="viewSheet" class="sheetContent" style="text-align: center;">
   <div class="headerA">
        <div class="spaceline">
            <div class="line"></div>
        </div>
        <div class="centro">
            <button class="btn-cancel" onclick="closeSheet('viewSheet')">􀆄</button>
            <div class="actions">
                    <button class="action pair" onclick="openStreak()">􁂥</button>
                <div class="pair">
                    <button class="single" onclick="deleteHabit()">􀈑</button>
                    <button class="single" onclick="editHabit()">􀈊</button>
                </div>
            </div>
        </div>
    </div>
    <div class="form" id="view">
    <div id="vIcon" style="font-size: 50px; margin-bottom: 10px;"></div>
    <div class="habito" id="vName"></div>
    <div id="vUnitLabel" ></div>
    
    <div class="qtyControls">
        <button class="plusminus" onclick="updateQty(-1)">􀅽</button>
        <input type="number" id="vQtyManual" class="manualQtyInput" defaultValue="0">
        <button class="plusminus" onclick="updateQty(1)">􀅼</button>
    </div>
    <div class="down">
        <div class="btones">
            <button class="btn btn-gray" onclick="clearQty()">Vaciar</button>
            <button class="btn btn-blue" onclick="setComplete()">Completar</button>
        </div>
     </div>
     
    </div>
</div>

<div id="iconPickerSheet" class="sheetContent" style="max-height: 40%;">
    <div class="headerIcons">
        <div class="spaceline">
            <div class="line"></div>
        </div>
        <div class="duo">
            <button class="btn-cancel" onclick="closeSheet('iconPickerSheet')">􀆄</button>
            <div class="subtitle">Icono</div>
            <button class="btn-action" id="confirmIconBtn">􀆅</button>
        </div>
    </div>
    <div class="iconGrid" id="iconGrid"></div>
</div>

<div id="streakSheet" class="sheetContent">
   <div class="headerA">
        <div class="spaceline">
            <div class="line"></div>
        </div>
        <div class="conjunto">
            <button class="btn-cancel" onclick="closeSheet('streakSheet')">􀆄</button>
        </div>
    </div>
    <div class="screen">
            <div class="streakBadge">
                <div class="fire">􀙭</div>
                <div id="streakValue">0</div>
                <div id="streakText">
                Días de racha
                </div>
            </div>
            <hr>
            <div class="subt">Actividad por mes</div>
            <div class="month">
                <div class="datenav">
                    <button class="navbtns" onclick="changeMonth(-1)">􀯶</button>
                    <div class="heading" id="calTitle"></div>
                    <button class="navbtns" onclick="changeMonth(1)">􀯻</button>
                </div>
                <div class="calGrid" id="calGrid"></div>
            </div>

            <div class="subt">Vista semanal</div>
            <div class="weekTracker">
            <div class="weekNav">
                <button class="navbtns" id="prevWeek">􀯶</button>
                <div class="heading" id="weekLabel"></div>
                <button class="navbtns" id="nextWeek">􀯻</button>
            </div>

            <div class="chart">
                <!-- 7 días -->
                <div class="day" data-day="0">
                <div class="bar"><div class="fill"></div></div>
                <div class="dayLabel">L</div>
                </div>
                <div class="day" data-day="1">
                <div class="bar"><div class="fill"></div></div>
                <div class="dayLabel">M</div>
                </div>
                <div class="day" data-day="2">
                <div class="bar"><div class="fill"></div></div>
                <div class="dayLabel">M</div>
                </div>
                <div class="day" data-day="3">
                <div class="bar"><div class="fill"></div></div>
                <div class="dayLabel">J</div>
                </div>
                <div class="day" data-day="4">
                <div class="bar"><div class="fill"></div></div>
                <div class="dayLabel">V</div>
                </div>
                <div class="day" data-day="5">
                <div class="bar"><div class="fill"></div></div>
                <div class="dayLabel">S</div>
                </div>
                <div class="day" data-day="6">
                <div class="bar"><div class="fill"></div></div>
                <div class="dayLabel">D</div>
                </div>
            </div>
</div>
</div>
</div>
</div>

<script>
    
    document.addEventListener('DOMContentLoaded', () => {
    const dateInput = document.getElementById('selectedDate');
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    dateInput.value = `${yyyy}-${mm}-${dd}`;

    // Actualizamos la variable global
    selectedDate = dateInput.value;

    // Renderizamos hábitos para la fecha actual
    renderHabits();
});

const addBtn = document.getElementById('addHabitBtn');
const sheet = document.querySelector('.sheetContent');

addBtn.addEventListener('click', () => {
  addBtn.classList.add('clickAnim');

  setTimeout(() => {
    sheet.classList.add('active'); // abre la sheet después de 400ms
    addBtn.classList.remove('clickAnim');
  }, 400); // delay mayor que la animación para que el feedback termine antes
});


function genId(){
    return 'id-' + Date.now().toString(36) + Math.random().toString(36).slice(2);
}

let habits = JSON.parse(localStorage.getItem('habits') || '[]');
habits.forEach(h => { if(!h.id) h.id = genId(); });
localStorage.setItem('habits', JSON.stringify(habits));

let currentHabitIdx = null;
let calDate = new Date();
const dateInput = document.getElementById('selectedDate');
dateInput.value = new Date().toISOString().split('T')[0];
let selectedDate = dateInput.value;

let activeSheet = null;

function resetCreateForm() {
    document.getElementById('hName').value = '';
    document.getElementById('uSing').value = '';
    document.getElementById('uPlur').value = '';
    document.getElementById('hGoal').value = '';
    document.getElementById('hStep').value = '';

    selectedIcon = '􀓔';
    selectedColor = '#777';
    iconTrigger.textContent = selectedIcon;
    iconTrigger.style.color = selectedColor;

    colorPicker.value = selectedColor;
    preview.style.background = selectedColor;
    wrap.classList.remove('active');
    presetRadios.forEach(r => r.checked = false);
}

let ignoreNextClick = false;
let zCounter = 1000;

function openSheet(id) {
    ignoreNextClick = true;

    if (activeSheet && activeSheet !== id) {
        const old = document.getElementById(activeSheet);
        old.style.zIndex = zCounter;
        closeSheet(activeSheet);
    }

    const content = document.getElementById(id);
    activeSheet = id;

    zCounter++;
    content.style.zIndex = zCounter;
    content.style.display = 'block';
    requestAnimationFrame(() => content.classList.add('active'));

    setTimeout(() => ignoreNextClick = false, 0);
}

document.addEventListener('click', (e) => {
    if (ignoreNextClick || !activeSheet) return;
    const sheet = document.getElementById(activeSheet);
    if (!sheet.contains(e.target)) closeSheet(activeSheet);
});

function closeSheet(id) {
    const content = document.getElementById(id);

    content.classList.add('closing');
    content.classList.remove('active');

    const handler = () => {
        content.style.display = 'none';
        content.classList.remove('closing');
        content.removeEventListener('transitionend', handler);
        if (activeSheet === id) activeSheet = null;
    };

    content.addEventListener('transitionend', handler);
}

// --- ICONOS Y COLORES ---
const emojiList = ['􀙪','􀠒','􀉛','􀤟','􁂙','􁌋','􀻑','􀟞','􀐙','􀈊','􀟛','􁚮','􁖏','􁓃','􁐡','􀝢','􀩼','􀇁','􀐮','􁔴','􀦉','􀆮','􀓔','􀜎','􂀇','􁖑','􁔨','􁔟','􀐬','􀙌','􀸩','􀥅','􀑈','􁖍','􀋞','􁋭','􀦛','􀈎','􀉼','􀊹','􀆿','􁕍','􀷾','􀍤','􀙈','􀨵','􂂇','􀈒','􁐿','􀉬','􀲯','􁐥','􁌟','􁌝','􀾡','􂏩','􁐆','􁐅','􀵟','􀑊','􀫔','􀑓','􀉉','􀈖','􀍰','􂏱','􀌟','􁂂','􀉀','􀖆','􀎙','􀟽','􀟖','􁞵','􀑫','􀎟','􀫘'];
let selectedIcon = '􀓔';
const iconTrigger = document.getElementById('iconPickerTrigger');
const colorPicker = document.getElementById('iconColorPicker');

const preview = document.getElementById('colorPreview');
const wrap = document.querySelector('.colorPickerWrap');

preview.style.background = colorPicker.value;

colorPicker.addEventListener('input', e => {
    preview.style.background = e.target.value;
    wrap.classList.add('active');
    selectedColor = e.target.value;
    iconTrigger.style.color = selectedColor;
});

const presetRadios = document.querySelectorAll('input[name="presetColor"]');
let selectedColor = colorPicker.value;

function initIcons() {
    const grid = document.getElementById('iconGrid');
    grid.innerHTML = "";

    emojiList.forEach(emoji => {
        const div = document.createElement('div');
        div.className = 'iconItem';
        div.textContent = emoji;

        if (emoji === selectedIcon) {
            div.classList.add('selected');
            div.style.color = selectedColor;
        }

div.onclick = () => {
    document.querySelectorAll('.iconItem').forEach(i => {
        i.classList.remove('selected');
        i.style.color = ''; // resetear color
    });

    selectedIcon = emoji;
    div.classList.add('selected');
    div.style.color = selectedColor; // solo colorea el seleccionado
};


        grid.appendChild(div);
    });
}
document.getElementById('confirmIconBtn').onclick = () => {
    iconTrigger.textContent = selectedIcon;
    iconTrigger.style.color = selectedColor;
    closeSheet('iconPickerSheet');
    openSheet('createSheet'); // volver al form
};

colorPicker.addEventListener('input', e => {
    preview.style.background = e.target.value;
    wrap.classList.add('active'); // mostrar X del picker
    selectedColor = e.target.value;
    iconTrigger.style.color = selectedColor;

    // desmarcar presets
    presetRadios.forEach(r => r.checked = false);
});
presetRadios.forEach(radio => {
    radio.addEventListener('change', () => {
        if (radio.checked) {
            selectedColor = radio.value;
            colorPicker.value = radio.value;
            iconTrigger.style.color = selectedColor;
            wrap.classList.remove('active'); 
        }
    });
});
function getStreak(h) {
    let streak = 0;
    let curr = new Date(); // Hoy
    curr.setHours(0, 0, 0, 0);

    while (true) {
        // Formato YYYY-MM-DD local
        let key = curr.getFullYear() + '-' + 
                  String(curr.getMonth() + 1).padStart(2, '0') + '-' + 
                  String(curr.getDate()).padStart(2, '0');
        
        if (h.history && h.history[key] >= h.goal) {
            streak++;
        } else {
            // Si es hoy y no está completo, la racha sigue viva por ayer
            let todayStr = new Date().getFullYear() + '-' + 
                           String(new Date().getMonth() + 1).padStart(2, '0') + '-' + 
                           String(new Date().getDate()).padStart(2, '0');
            if (key === todayStr) {
                // No sumamos pero seguimos buscando
            } else {
                break; 
            }
        }
        curr.setDate(curr.getDate() - 1);
    }
    return streak;
}
function renderHabits(updatedId = null) {
   
    const container = document.getElementById('habitsContainer');
    
    const firstPositions = {};
    [...container.children].forEach(el => firstPositions[el.dataset.id] = el.getBoundingClientRect());

    const sorted = [...habits].sort((a, b) => {
        const ca = (a.history[selectedDate] || 0) >= a.goal;
        const cb = (b.history[selectedDate] || 0) >= b.goal;
        return ca === cb ? 0 : ca ? 1 : -1;
    });

    container.innerHTML = sorted.map(h => {
        const i = habits.findIndex(x => x.id === h.id);
        const qty = h.history[selectedDate] || 0;
        const isComplete = qty >= h.goal;
        const progress = Math.min(100, (qty / h.goal) * 100);
// Dentro del map de habits en renderHabits:
const streak = getStreak(h); // <--- Solo esta línea
        // Si este es el hábito que actualizamos, empezamos en 0 para que se vea la animación
        // Si no, mostramos el progreso actual de una vez
        const startWidth = (h.id === updatedId) ? 0 : progress;

        return `
            <div class="habitCard ${isComplete ? 'completed' : ''}" data-id="${h.id}" 
                 style="background-color: ${h.iconColor}12" onclick="openView(${i})">
                <div class="habitIconCircle" style="color: ${h.iconColor}">${h.icon}</div>
                <div class="habitInfo">
                     <div class="cont">
                        <div class="details">
                            <div class="dup">
                                <div class="habitName">${h.name}</div>
                                ${streak > 0 ? `<span class="streak">􀙭 <div class="streaknum">${streak}</div></span>` : ''}
                            </div>
                        </div>
                     </div>
                    ${h.goal > 1 ? `
                    <div class="habitProgressBar">
                        <div class="habitProgressBarInner" 
                             data-w="${progress}%" 
                             style="width: ${startWidth}%; background: ${h.iconColor};">
                        </div>
                    </div>` : ''}
                    ${h.goal > 1 ? `<div class="habitProgressBadge" style="color: ${h.iconColor}">
                        ${(qty !=  0 && qty != h.goal ) ? `<div class="cantidad">
                           <div class="hecho">${qty} ${qty !=  1 ? h.uPlur : h.uSing}</div>
                           <div class="meta">${h.goal} ${h.uPlur}</div>
                        </div>`:''}
                     </div>` : ''}
                </div>
                <button class="botoncito" style="background-color: ${isComplete ? h.iconColor + '70' : h.iconColor}"
                        onclick="event.stopPropagation(); ${isComplete ? 'openStreak()' : `updateQty(1, ${i})`}">
                    ${isComplete ? '􀆅' : '􀅼'}
                </button>
            </div>`;
    }).join('');

    requestAnimationFrame(() => {
        const bars = container.querySelectorAll('.habitProgressBarInner');
        bars.forEach(bar => {
            // Solo disparamos la animación si el ancho actual es diferente al destino (data-w)
            if (bar.style.width !== bar.dataset.w) {
                bar.getBoundingClientRect(); 
                bar.style.width = bar.dataset.w;
            }
        });

        [...container.children].forEach(el => {
            const last = el.getBoundingClientRect();
            const first = firstPositions[el.dataset.id];
            if (!first) return;
            const dy = first.top - last.top;
            if (dy === 0) return;
            el.style.transform = `translateY(${dy}px)`;
            el.style.transition = 'none';
            requestAnimationFrame(() => { 
                el.style.transform = ''; 
                el.style.transition = 'transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1)'; 
            });
        });
    });
}
function openView(i) {
    currentHabitIdx = i;
    const h = habits[i];
    document.getElementById('vName').textContent = h.name;
    document.getElementById('vIcon').textContent = h.icon;
    document.getElementById('vIcon').style.color = h.iconColor;
    document.getElementById('vQtyManual').value = h.history[selectedDate] || 0;
    document.getElementById('vUnitLabel').textContent = `Meta: ${h.goal} ${h.uPlur}`;
    openSheet('viewSheet');
}

function updateQty(dir, idx = null) {
    const i = (idx !== null) ? idx : currentHabitIdx;
    if (i === null) return;
    const h = habits[i];
    const current = h.history[selectedDate] || 0;
    
    h.history[selectedDate] = Math.max(0, current + (dir * h.step));
    
    if (idx === null) document.getElementById('vQtyManual').value = h.history[selectedDate];
    
    localStorage.setItem('habits', JSON.stringify(habits));
    // Pasamos el ID para que solo este hábito se anime
    renderHabits(h.id); 
}

function setComplete() { 
    const h = habits[currentHabitIdx];
    // En lugar de 999, ponemos exactamente la meta
    h.history[selectedDate] = h.goal; 
    localStorage.setItem('habits', JSON.stringify(habits));
    renderHabits(h.id); 
    closeSheet('viewSheet'); 
}

document.getElementById('vQtyManual').onchange = (e) => {
    habits[currentHabitIdx].history[selectedDate] = parseInt(e.target.value) || 0;
    localStorage.setItem('habits', JSON.stringify(habits));
    renderHabits();
};

function saveHabit() {
    const goal = parseInt(document.getElementById('hGoal').value, 10);
const step = parseInt(document.getElementById('hStep').value, 10);

if (isNaN(goal) || isNaN(step) || goal <= 0 || step <= 0) {
    alert('Ingresa un número entero mayor a 0');
    return;
}

    const name = document.getElementById('hName').value.trim();
    if (!name) {
        alert('El nombre es obligatorio');
        return;
    }
    const h = {
        id: currentHabitIdx !== null ? habits[currentHabitIdx].id : genId(),
        name: document.getElementById('hName').value,
        uSing: document.getElementById('uSing').value || 'vez',
        uPlur: document.getElementById('uPlur').value || 'veces',
        goal: parseInt(document.getElementById('hGoal').value) || 1,
        step: parseInt(document.getElementById('hStep').value) || 1,
        icon: selectedIcon,
        iconColor: selectedColor,
        history: currentHabitIdx !== null ? habits[currentHabitIdx].history : {}
    };

    if (!h.name) return;

    if (currentHabitIdx !== null) habits[currentHabitIdx] = h;
    else habits.push(h);

    localStorage.setItem('habits', JSON.stringify(habits));
    renderHabits();
    closeSheet('createSheet');

    // ahora sí, aquí va el reset
    resetCreateForm();
}


function editHabit() {
    const h = habits[currentHabitIdx];
    document.getElementById('hName').value = h.name;
    document.getElementById('uSing').value = h.uSing;
    document.getElementById('uPlur').value = h.uPlur;
    document.getElementById('hGoal').value = h.goal;
    document.getElementById('hStep').value = h.step;
    selectedIcon = h.icon;
    selectedColor = h.iconColor;
    iconTrigger.textContent = h.icon;
    iconTrigger.style.color = h.iconColor;
    closeSheet('viewSheet');
    openSheet('createSheet');
}

function deleteHabit() {
    if(confirm('¿Borrar hábito?')) {
        habits.splice(currentHabitIdx, 1);
        localStorage.setItem('habits', JSON.stringify(habits));
        renderHabits(); 
        closeSheet('viewSheet');
    }
}
function getWeekOffset(targetDateStr) {
    let now = new Date();
    now.setHours(0, 0, 0, 0);

    // Lunes de la semana de "hoy"
    let dayNow = now.getDay();
    let diffNow = (dayNow === 0 ? -6 : 1) - dayNow;
    let mondayNow = new Date(now);
    mondayNow.setDate(now.getDate() + diffNow);

    // Lunes de la fecha seleccionada
    let target = new Date(targetDateStr + "T00:00:00"); // Forzamos hora local
    let dayTarget = target.getDay();
    let diffTarget = (dayTarget === 0 ? -6 : 1) - dayTarget;
    let mondayTarget = new Date(target);
    mondayTarget.setDate(target.getDate() + diffTarget);

    const msInWeek = 1000 * 60 * 60 * 24 * 7;
    return Math.round((mondayTarget - mondayNow) / msInWeek);
}
function openStreak() {
    const h = habits[currentHabitIdx];
    
    // 1. Calcular racha con la función unificada
    const racha = getStreak(h);
    
    // 2. Actualizar el UI de la racha (el badge que creamos)
    document.getElementById('streakValue').textContent = racha;
    document.getElementById('streakText').textContent = racha === 1 ? 'Día de racha' : 'Días de racha';
    
const streakValue = document.getElementById("streakValue");
const fire = document.querySelector(".fire");

// Aplicar grayscale si racha = 0
if (racha === 0) {
    fire.style.filter = "grayscale(100%)";
    fire.style.opacity = "0.5";
} else {
    fire.style.filter = "grayscale(0%)";
    fire.style.opacity = "1";
}

    // 3. El resto de tu lógica de calendario y gráficas
    weekOffset = getWeekOffset(selectedDate); 
    calDate = new Date(selectedDate);
    renderCalendar();
    updateChart();
    openSheet('streakSheet');
}
function renderCalendar() {
    const h = habits[currentHabitIdx];
    const grid = document.getElementById('calGrid');
    grid.innerHTML = '';
    const month = calDate.getMonth(), year = calDate.getFullYear();
    document.getElementById('calTitle').textContent = new Intl.DateTimeFormat('es-ES', { month: 'long', year: 'numeric' }).format(calDate);
    // 1. Cambiamos el orden de las etiquetas
    const diasLabels = ['Lu','Ma','Mi','Ju','Vi','Sa','Do'];
    diasLabels.forEach(d => {
        const div = document.createElement('div'); 
        div.style.color='#8E8E93'; 
        div.textContent = d; 
        grid.appendChild(div);
    });

    const firstDayRaw = new Date(year, month, 1).getDay();
    // 2. Ajuste para que Lunes sea 0 y Domingo sea 6
    const firstDay = (firstDayRaw === 0) ? 6 : firstDayRaw - 1;

    const daysInMonth = new Date(year, month + 1, 0).getDate();

    for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));
    for(let d=1; d<=daysInMonth; d++) {
        const key = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const qty = h.history[key] || 0;
        const goal = h.goal;
        const progress = Math.min(1, qty / goal);
        
        // El perímetro de un círculo con radio 18 es ~113
        const radius = 18;
        const circ = 2 * Math.PI * radius;
        const offset = circ - (progress * circ);

        const cell = document.createElement('div');
        cell.className = 'dayCell';
        
        // Insertamos el SVG del Ring
        cell.innerHTML = `
            <svg class="ring" viewBox="0 0 44 44">
                <circle class="ring-bg" cx="22" cy="22" r="${radius}"></circle>
                <circle class="ring-fg" cx="22" cy="22" r="${radius}" 
                    style="stroke-dasharray: ${circ}; stroke-dashoffset: ${offset}; color: ${h.iconColor}; opacity: ${qty > 0 ? 1 : 0}">
                </circle>
            </svg>
            <span class="dayNum">${d}</span>
        `;

        // Si está completado, podemos resaltar el número o el fondo opcionalmente
        if(qty >= goal) {
            cell.querySelector('.dayNum').style.color = h.iconColor;
            cell.querySelector('.dayNum').style.fontWeight = '700';
        }

        grid.appendChild(cell);
    }
}
function changeMonth(dir) { calDate.setMonth(calDate.getMonth()+dir); renderCalendar(); }
// Variable global para controlar qué semana vemos (0 = actual, -1 = anterior, etc.)
let weekOffset = 0;
function updateChart() {
    const h = habits[currentHabitIdx];
    if (!h) return;

    const bars = document.querySelectorAll('.day .fill');
    const daysContainer = document.querySelectorAll('.day');
    const weekLabel = document.getElementById('weekLabel');
    
    let now = new Date();
    now.setHours(0, 0, 0, 0);

    let dayOfWeek = now.getDay(); 
    let diffToMonday = (dayOfWeek === 0 ? -6 : 1) - dayOfWeek;
    
    let startOfWeek = new Date(now);
    startOfWeek.setDate(now.getDate() + diffToMonday + (weekOffset * 7));

    // --- NUEVA LÓGICA DE ESCALA ---
    // Calculamos el valor máximo de la semana para que las barras se ajusten
    let weeklyValues = [];
    for (let i = 0; i < 7; i++) {
        let d = new Date(startOfWeek);
        d.setDate(startOfWeek.getDate() + i);
        let key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
        weeklyValues.push(h.history[key] || 0);
    }
    
    // El máximo será el valor más alto registrado o la meta (lo que sea mayor)
    let maxInChart = Math.max(...weeklyValues, h.goal);

    // Etiqueta de la semana
    let endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6);
    weekLabel.textContent = `${startOfWeek.getDate()} ${startOfWeek.toLocaleString('es-ES', {month:'short'})} - ${endOfWeek.getDate()} ${endOfWeek.toLocaleString('es-ES', {month:'short'})}`;

    for (let i = 0; i < 7; i++) {
        let d = new Date(startOfWeek);
        d.setDate(startOfWeek.getDate() + i);
        let key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
        
        let qty = h.history[key] || 0;
        let isToday = d.toDateString() === new Date().toDateString();
        let isComplete = qty >= h.goal;

        // Calculamos la altura relativa al máximo de la semana
        let heightPercentage = (qty / maxInChart) * 100;

        if (bars[i]) {
            // 1. Ajuste de altura y color
            bars[i].style.height = `${heightPercentage}%`;
            bars[i].style.backgroundColor = isToday ? h.iconColor : "#D1D1D6"; // Color solo si es hoy
            
            // 2. Gestionar el Check (si qty >= goal)
            // Eliminamos check anterior si existe
            const existingCheck = daysContainer[i].querySelector('.check-mark');
            if (existingCheck) existingCheck.remove();

            if (isComplete) {
                const check = document.createElement('div');
                check.className = 'check-mark';
                check.textContent = '􀁣'; // Icono de check (SF Pro)
                check.style.cssText = `color: ${h.iconColor};`;
                daysContainer[i].appendChild(check);
            }

            // 3. Estilo del texto inferior
            const dayLabel = daysContainer[i].querySelector('.dayLabel');
            dayLabel.style.color = isToday ? h.iconColor : "#8E8E93";
            dayLabel.style.fontWeight = isToday ? 'bold' : '500';
        } 
    }
}

document.getElementById('prevWeek').onclick = () => {
    weekOffset--;
    updateChart();
};

document.getElementById('nextWeek').onclick = () => {
    weekOffset++;
    updateChart();
};

updateChart();

function clearQty() { habits[currentHabitIdx].history[selectedDate] = 0; localStorage.setItem('habits', JSON.stringify(habits)); renderHabits(); closeSheet('viewSheet'); }

document.getElementById('addHabitBtn').onclick = () => { 
    currentHabitIdx = null; 
    resetCreateForm();
    openSheet('createSheet'); 
};


document.getElementById('iconPickerTrigger').onclick = () => openSheet('iconPickerSheet');
dateInput.onchange = (e) => { selectedDate = e.target.value; renderHabits(); };

initIcons();
renderHabits();

</script>
</body>
</html>